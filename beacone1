#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

#include <BLEDevice.h>
#include <BLEScan.h>
#include <BLEAdvertisedDevice.h>

// ====================== DISPLAY ======================
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire);

// ====================== BOTAO ========================
#define BOTAO 4
const unsigned long LONG_PRESS_MS = 2000;  // 2 segundos

bool botaoAnterior = HIGH;
unsigned long instantePressionado = 0;

// ====================== BEACONS ======================
// MACs dos beacons (exatamente como o app mostra)
const char* MAC_TEAR_92 = "E0:93:8A:13:88:DA";
const char* MAC_TEAR_23 = "ED:7D:42:03:7F:D7";

BLEScan* pBLEScan;

// Info do ultimo scan
bool beaconVisivel = false;
int  tearMaisProximo = 0;   // 0 = nenhum, 92 ou 23
int  rssiMaisProximo = 0;

// Valores "capturados" no clique curto
bool capturado = false;
int  tearCapturado = 0;
int  rssiCapturado = 0;

// ====================== FUNCOES ======================

void scanBeacon() {
  beaconVisivel = false;
  tearMaisProximo = 0;

  int rssi92 = -999;
  int rssi23 = -999;
  bool achou92 = false;
  bool achou23 = false;

  BLEScanResults results = *pBLEScan->start(1, false); // scan de 1s
  int count = results.getCount();

  for (int i = 0; i < count; i++) {
    BLEAdvertisedDevice d = results.getDevice(i);
    String mac = d.getAddress().toString();  // ex: "ed:7d:42:03:7f:d7"

    if (mac.equalsIgnoreCase(MAC_TEAR_92)) {
      achou92 = true;
      rssi92 = d.getRSSI();
    }

    if (mac.equalsIgnoreCase(MAC_TEAR_23)) {
      achou23 = true;
      rssi23 = d.getRSSI();
    }
  }

  pBLEScan->clearResults();

  // Decide qual eh o mais proximo (RSSI maior = mais perto)
  if (achou92 || achou23) {
    beaconVisivel = true;

    if (achou92 && (!achou23 || rssi92 >= rssi23)) {
      tearMaisProximo = 92;
      rssiMaisProximo = rssi92;
    } else if (achou23) {
      tearMaisProximo = 23;
      rssiMaisProximo = rssi23;
    }
  }
}

void atualizaDisplay() {
  display.clearDisplay();
  display.setTextSize(2);
  display.setTextColor(WHITE);
  display.setCursor(0, 0);

  if (capturado && tearCapturado != 0) {
    // Mostra TEAR capturado
    display.print("TEAR ");
    display.println(tearCapturado);

    display.setTextSize(1);
    display.setCursor(0, 30);
    display.print("RSSI: ");
    display.print(rssiCapturado);
    display.println(" dBm");
  } else {
    // Modo aguardando
    display.println("AGUARDANDO");
    display.setTextSize(1);
    display.setCursor(0, 30);

    if (beaconVisivel && tearMaisProximo != 0) {
      display.print("Mais prox: TEAR ");
      display.print(tearMaisProximo);
      display.print(" (");
      display.print(rssiMaisProximo);
      display.println(" dBm)");
    } else {
      display.println("Sem beacon");
    }
  }

  display.display();
}

void trataBotao() {
  int estado = digitalRead(BOTAO);

  // transicao solto -> pressionado
  if (estado == LOW && botaoAnterior == HIGH) {
    instantePressionado = millis();
  }

  // transicao pressionado -> solto
  if (estado == HIGH && botaoAnterior == LOW) {
    unsigned long duracao = millis() - instantePressionado;

    if (duracao >= LONG_PRESS_MS) {
      // Long press: limpar captura
      capturado = false;
      tearCapturado = 0;
    } else {
      // Clique curto: capturar beacon mais proximo no momento
      if (beaconVisivel && tearMaisProximo != 0) {
        capturado = true;
        tearCapturado = tearMaisProximo;
        rssiCapturado = rssiMaisProximo;
      } else {
        // Se quiser, pode manter capturado = false
        capturado = false;
        tearCapturado = 0;
      }
    }
  }

  botaoAnterior = estado;
}

// ====================== SETUP ========================

void setup() {
  Serial.begin(115200);

  // Botao
  pinMode(BOTAO, INPUT_PULLUP); // botao ligado ao GND

  // I2C display
  Wire.begin(21, 22);  // SDA=21, SCL=22

  if (!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
    Serial.println("Erro ao inicializar display!");
    while (true);
  }
  display.clearDisplay();
  display.display();

  // BLE
  BLEDevice::init("");
  pBLEScan = BLEDevice::getScan();
  pBLEScan->setActiveScan(true);
  pBLEScan->setInterval(100);
  pBLEScan->setWindow(80);

  Serial.println("Sistema iniciado.");
}

// ====================== LOOP =========================

void loop() {
  // 1) Escaneia beacons (92 e 23) e calcula qual est√° mais perto
  scanBeacon();

  // 2) Trata clique / long press
  trataBotao();

  // 3) Atualiza o display com o estado atual
  atualizaDisplay();

  delay(100);
}
