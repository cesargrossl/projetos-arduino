#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SH110X.h>

#include <BLEDevice.h>
#include <BLEScan.h>
#include <BLEAdvertisedDevice.h>

#include "qrcode.h"

// ================= DISPLAY =================
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET -1
Adafruit_SH1106G display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

// ================= BOTOES ==================
#define BTN_CAPTURA 4   // Botão 1: captura / limpar
#define BTN_QR      5   // Botão 2: gerar QR

const unsigned long LIMPA_PRESS_MS = 5000; // segurar >=5s para limpar

bool btn1Anterior = HIGH;
unsigned long btn1PressStart = 0;

// ================= BEACONS =================
const char* MAC_TEAR_92 = "E0:93:8A:13:88:DA";
const char* MAC_TEAR_23 = "ED:7D:42:03:7F:D7";

BLEScan* pBLEScan;

// Info do ultimo scan
bool beaconVisivel    = false;
int  tearMaisProximo  = 0;   // 0 = nenhum, 55 ou 56
int  rssiMaisProximo  = 0;

// Valores capturados
bool capturado     = false;
int  tearCapturado = 0;
int  rssiCapturado = 0;

// ================= QR CODE =================
bool modoQRCode = false;          // true = mostrar QR na tela
unsigned long qrMensagemAte = 0;  // para mensagem "SEM CAPTURA"

// ================= FUNCOES =================

void scanBeacon() {
  beaconVisivel = false;
  tearMaisProximo = 0;

  int rssi92 = -999;
  int rssi23 = -999;
  bool achou92 = false;
  bool achou23 = false;

  BLEScanResults results = *pBLEScan->start(1, false); // scan de 1s
  int count = results.getCount();

  for (int i = 0; i < count; i++) {
    BLEAdvertisedDevice d = results.getDevice(i);
    String mac = d.getAddress().toString();

    if (mac.equalsIgnoreCase(MAC_TEAR_92)) {
      achou92 = true;
      rssi92 = d.getRSSI();
    }
    if (mac.equalsIgnoreCase(MAC_TEAR_23)) {
      achou23 = true;
      rssi23 = d.getRSSI();
    }
  }

  pBLEScan->clearResults();

  if (achou92 || achou23) {
    beaconVisivel = true;

    if (achou92 && (!achou23 || rssi92 >= rssi23)) {
      tearMaisProximo = 55;
      rssiMaisProximo = rssi92;
    } else {
      tearMaisProximo = 56;
      rssiMaisProximo = rssi23;
    }
  }
}

// ---------- QR CODE: desenha no OLED ----------
void drawQRCodeOLED(esp_qrcode_handle_t qrcode) {
  int size = esp_qrcode_get_size(qrcode);
  int scale = 2; // se quiser maior: 3 (pode cortar dependendo do tamanho do QR)

  int offsetX = (SCREEN_WIDTH  - size * scale) / 2;
  int offsetY = (SCREEN_HEIGHT - size * scale) / 2;

  display.clearDisplay();

  for (int y = 0; y < size; y++) {
    for (int x = 0; x < size; x++) {
      if (esp_qrcode_get_module(qrcode, x, y)) {
        display.fillRect(offsetX + x * scale,
                         offsetY + y * scale,
                         scale, scale,
                         SH110X_WHITE);
      }
    }
  }
  display.display();
}

void desenhaQRCode(const char* texto) {
  esp_qrcode_config_t cfg = ESP_QRCODE_CONFIG_DEFAULT();
  cfg.display_func       = drawQRCodeOLED;
  cfg.max_qrcode_version = 10;
  cfg.qrcode_ecc_level   = ESP_QRCODE_ECC_LOW;

  esp_qrcode_generate(&cfg, texto);
}

// ================= ACOES =================

void acaoCapturar() {
  if (beaconVisivel && tearMaisProximo != 0) {
    capturado = true;
    tearCapturado = tearMaisProximo;
    rssiCapturado = rssiMaisProximo;
    modoQRCode = false; // volta para tela normal
  } else {
    // se não tem beacon, não captura
    capturado = false;
    tearCapturado = 0;
    rssiCapturado = 0;
    modoQRCode = false;
  }
}

void acaoLimpar() {
  capturado = false;
  tearCapturado = 0;
  rssiCapturado = 0;
  modoQRCode = false;
}

void acaoGerarQR() {
  if (capturado && tearCapturado != 0) {
    modoQRCode = true;
  } else {
    // mostra mensagem por 2s
    modoQRCode = false;
    qrMensagemAte = millis() + 2000;
  }
}

// ================= LEITURA DOS BOTOES =================

void trataBtnCaptura() {
  int estado = digitalRead(BTN_CAPTURA);

  // solto -> pressionado
  if (estado == LOW && btn1Anterior == HIGH) {
    btn1PressStart = millis();
  }

  // pressionado -> solto
  if (estado == HIGH && btn1Anterior == LOW) {
    unsigned long dur = millis() - btn1PressStart;

    if (dur >= LIMPA_PRESS_MS) {
      acaoLimpar();
    } else {
      acaoCapturar();
    }
  }

  btn1Anterior = estado;
}

void trataBtnQR() {
  // botão 2: clique simples
  static bool btn2Anterior = HIGH;
  int estado = digitalRead(BTN_QR);

  if (estado == HIGH && btn2Anterior == LOW) {
    // soltou = clique
    acaoGerarQR();
  }

  btn2Anterior = estado;
}

// ================= DISPLAY =================

void atualizaDisplay() {

  // Se estiver em modo QR e tiver captura, desenha QR
  if (modoQRCode && capturado && tearCapturado != 0) {
      char buffer[8];
      snprintf(buffer, sizeof(buffer), "%d", tearCapturado);
      desenhaQRCode(buffer);
      return;
  }

  display.clearDisplay();
  display.setTextColor(SH110X_WHITE);

  // Mensagem temporária (ex: sem captura)
  if (millis() < qrMensagemAte) {
    display.setTextSize(2);
    display.setCursor(0, 18);
    display.println("SEM");
    display.setCursor(0, 38);
    display.println("CAPTURA");
    display.display();
    return;
  }

  if (capturado && tearCapturado != 0) {
    display.setTextSize(2);
    display.setCursor(0, 0);
    display.print("TEAR ");
    display.println(tearCapturado);

    display.setTextSize(1);
    display.setCursor(0, 30);
    display.print("RSSI: ");
    display.print(rssiCapturado);
    display.println(" dBm");

    display.setCursor(0, 48);
    display.println("BTN2: QR  | BTN1: seg 5s limpa");
  } else {
    display.setTextSize(2);
    display.setCursor(0, 0);
    display.println("AGUARDANDO");

    display.setTextSize(1);
    display.setCursor(0, 30);

    if (beaconVisivel && tearMaisProximo != 0) {
      display.print("Mais prox: TEAR ");
      display.print(tearMaisProximo);
      display.print(" (");
      display.print(rssiMaisProximo);
      display.println(" dBm)");
    } else {
      display.println("Sem beacon");
    }

    display.setCursor(0, 50);
    display.println("BTN1: captura | BTN2: QR");
  }

  display.display();
}

// ================= SETUP =================

void setup() {
  Serial.begin(115200);

  pinMode(BTN_CAPTURA, INPUT_PULLUP); // botões para GND
  pinMode(BTN_QR, INPUT_PULLUP);

  Wire.begin(21, 22);

  if (!display.begin(0x3C, true)) {  // tente 0x3D se precisar
    Serial.println("Erro ao inicializar OLED SH1106!");
    while (true);
  }

  display.setContrast(0xFF);
  display.setRotation(0);
  display.clearDisplay();
  display.display();

  // BLE
  BLEDevice::init("");
  pBLEScan = BLEDevice::getScan();
  pBLEScan->setActiveScan(true);
  pBLEScan->setInterval(100);
  pBLEScan->setWindow(80);

  Serial.println("Sistema iniciado.");
}

// ================= LOOP =================

void loop() {
  scanBeacon();

  trataBtnCaptura();
  trataBtnQR();

  atualizaDisplay();

  delay(50);
}
