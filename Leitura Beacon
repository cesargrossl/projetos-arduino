#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

#include <BLEDevice.h>
#include <BLEScan.h>
#include <BLEAdvertisedDevice.h>

#include "qrcode.h"

// ================= DISPLAY =================
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET -1

Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

// ================= BOTAO ==================
#define BOTAO 4
const unsigned long CLEAR_PRESS_MS = 2000;
const unsigned long QR_PRESS_MS = 10000;

bool botaoAnterior = HIGH;
unsigned long instantePressionado = 0;

// ================= BEACONS ================
const char* MAC_TEAR_92 = "E0:93:8A:13:88:DA";
const char* MAC_TEAR_23 = "ED:7D:42:03:7F:D7";

BLEScan* pBLEScan;

bool beaconVisivel = false;
int tearMaisProximo = 0;
int rssiMaisProximo = 0;

bool capturado = false;
int tearCapturado = 0;
int rssiCapturado = 0;

// ================= QR =====================
bool modoQRCode = false;

// ================= BLE SCAN ==============

void scanBeacon() {
  beaconVisivel = false;
  tearMaisProximo = 0;

  int rssi92 = -999;
  int rssi23 = -999;
  bool achou92 = false;
  bool achou23 = false;

  BLEScanResults results = *pBLEScan->start(1, false);

  for (int i = 0; i < results.getCount(); i++) {
    BLEAdvertisedDevice d = results.getDevice(i);
    String mac = d.getAddress().toString();

    if (mac.equalsIgnoreCase(MAC_TEAR_92)) {
      achou92 = true;
      rssi92 = d.getRSSI();
    }

    if (mac.equalsIgnoreCase(MAC_TEAR_23)) {
      achou23 = true;
      rssi23 = d.getRSSI();
    }
  }

  pBLEScan->clearResults();

  if (achou92 || achou23) {
    beaconVisivel = true;

    if (achou92 && (!achou23 || rssi92 >= rssi23)) {
      tearMaisProximo = 55;
      rssiMaisProximo = rssi92;
    } else {
      tearMaisProximo = 56;
      rssiMaisProximo = rssi23;
    }
  }
}

// ================= QR DRAW ===============

void drawQRCodeOLED(esp_qrcode_handle_t qrcode) {
  int size = esp_qrcode_get_size(qrcode);
  int scale = 2;

  int offsetX = (SCREEN_WIDTH - size * scale) / 2;
  int offsetY = (SCREEN_HEIGHT - size * scale) / 2;

  display.clearDisplay();

  for (int y = 0; y < size; y++) {
    for (int x = 0; x < size; x++) {
      if (esp_qrcode_get_module(qrcode, x, y)) {
        display.fillRect(offsetX + x * scale,
                         offsetY + y * scale,
                         scale,
                         scale,
                         WHITE);
      }
    }
  }

  display.display();
}

void desenhaQRCode(const char* texto) {
  esp_qrcode_config_t cfg = ESP_QRCODE_CONFIG_DEFAULT();
  cfg.display_func = drawQRCodeOLED;
  cfg.max_qrcode_version = 10;
  cfg.qrcode_ecc_level = ESP_QRCODE_ECC_LOW;

  esp_qrcode_generate(&cfg, texto);
}

// ================= DISPLAY ===============

void atualizaDisplay() {

  if (modoQRCode && capturado && tearCapturado != 0) {
    char buffer[40];
    snprintf(buffer, sizeof(buffer), "TEAR=%d;RSSI=%d",
             tearCapturado, rssiCapturado);
    desenhaQRCode(buffer);
    return;
  }

  display.clearDisplay();
  display.setTextColor(WHITE);

  if (capturado) {
    display.setTextSize(2);
    display.setCursor(0, 0);
    display.print("TEAR ");
    display.println(tearCapturado);

    display.setTextSize(1);
    display.setCursor(0, 32);
    display.print("RSSI ");
    display.print(rssiCapturado);
  } else {
    display.setTextSize(1);
    display.setCursor(0, 0);
    display.println("AGUARDANDO");

    if (beaconVisivel) {
      display.print("Prox: ");
      display.print(tearMaisProximo);
      display.print(" ");
      display.print(rssiMaisProximo);
    } else {
      display.println("Sem beacon");
    }
  }

  display.display();
}

// ================= ACOES =================

void acaoCliqueSimples() {
  if (beaconVisivel) {
    capturado = true;
    tearCapturado = tearMaisProximo;
    rssiCapturado = rssiMaisProximo;
  }
  modoQRCode = false;
}

void acaoMostrarQRCode() {
  if (beaconVisivel) {
    capturado = true;
    tearCapturado = tearMaisProximo;
    rssiCapturado = rssiMaisProximo;
  }
  modoQRCode = true;
}

void acaoLongPress() {
  capturado = false;
  modoQRCode = false;
}

// ================= BOTAO =================

void trataBotao() {
  int estado = digitalRead(BOTAO);

  if (estado == LOW && botaoAnterior == HIGH)
    instantePressionado = millis();

  if (estado == HIGH && botaoAnterior == LOW) {
    unsigned long d = millis() - instantePressionado;

    if (d >= QR_PRESS_MS) acaoMostrarQRCode();
    else if (d >= CLEAR_PRESS_MS) acaoLongPress();
    else acaoCliqueSimples();
  }

  botaoAnterior = estado;
}

// ================= SETUP =================

void setup() {
  Serial.begin(115200);

  pinMode(BOTAO, INPUT_PULLUP);

  Wire.begin(21, 22);

  if (!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) { // tente 0x3D se nÃ£o ligar
    Serial.println("OLED erro");
    while (1);
  }

  display.clearDisplay();
  display.display();

  BLEDevice::init("");
  pBLEScan = BLEDevice::getScan();
  pBLEScan->setActiveScan(true);

  Serial.println("Sistema iniciado");
}

// ================= LOOP ==================

void loop() {
  scanBeacon();
  trataBotao();
  atualizaDisplay();
  delay(50);
}
